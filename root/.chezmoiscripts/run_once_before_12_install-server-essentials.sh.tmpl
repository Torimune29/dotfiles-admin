#!/usr/bin/env sh

set -eu

{{ if .requestServerEssentials }}

{{- $repositorySpecific := dict
  "apt"     (cat "openssh-server passwd         adduser")
  "yum"     (cat "openssh-server passwd         adduser")
  "dnf"     (cat "openssh-server shadow-utils-2 adduser")
  "zypper"  (cat "openssh        passwd         adduser")
  "apk"     (cat "openssh-server shadow")
-}}

{{- $requestPackages := cat
  "sudo"
  (get $repositorySpecific .packageManager)
-}}

{{ template "sudo" cat .install $requestPackages }}

# add admin user
userdel -r {{ .requestServerAdminUserName }} | true
useradd -m -s $(which bash) {{ .requestServerAdminUserName }}
passwd {{ .requestServerAdminUserName }} <<EOF
{{ .requestServerAdminPassword }}
{{ .requestServerAdminPassword }}
EOF
usermod -G {{ .requestServerAdminGroup }} {{ .requestServerAdminUserName }}

# set sudoers
mkdir -p /etc/sudoers.d
cat <<EOF > /etc/sudoers.d/{{ .requestServerAdminGroup }}
%{{ .requestServerAdminGroup }} ALL=(ALL) ALL
%{{ .requestServerAdminGroup }} ALL=(ALL) NOPASSWD: ALL

Defaults:%{{ .requestServerAdminGroup }} !requiretty
Defaults:%{{ .requestServerAdminGroup }} env_keep += SSH_AUTH_SOCK
EOF
chmod 0440 /etc/sudoers.d/{{ .requestServerAdminGroup }}

{{ end }}
