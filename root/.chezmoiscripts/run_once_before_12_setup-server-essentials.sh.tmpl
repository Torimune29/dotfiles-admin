#!/usr/bin/env sh

set -eu

{{ if .requestServerEssentials }}

{{- $repositorySpecific := dict
  "apt"     (cat "openssh-server passwd")
  "yum"     (cat "openssh-server passwd")
  "dnf"     (cat "openssh-server passwd")
  "zypper"  (cat "openssh        passwd")
  "apk"     (cat "openssh-server shadow")
-}}

{{- $requestPackages := cat
  "sudo"
  (get $repositorySpecific .packageManager)
-}}

{{ template "sudo" cat .install $requestPackages }}

# add admin user
userdel -r {{ .requestServerAdminUserName }} | true
groupdel {{ .requestServerAdminGroup }} | true
groupadd {{ .requestServerAdminGroup }}
useradd -s /bin/bash -g {{ .requestServerAdminGroup }} {{ .requestServerAdminUserName }}
echo "{{ .requestServerAdminUserName }}:{{ .requestServerAdminPassword }}" | chpasswd

# set sudoers
mkdir -p /etc/sudoers.d
cat <<EOF > /etc/sudoers.d/{{ .requestServerAdminGroup }}
%{{ .requestServerAdminGroup }} ALL=(ALL) ALL
%{{ .requestServerAdminGroup }} ALL=(ALL) NOPASSWD: ALL

Defaults:%{{ .requestServerAdminGroup }} !requiretty
Defaults:%{{ .requestServerAdminGroup }} env_keep += SSH_AUTH_SOCK
EOF
chmod 0440 /etc/sudoers.d/{{ .requestServerAdminGroup }}

{{ end }}
